<!DOCTYPE HTML>
<html>

<head>
    <title>Dominion Card Image Generator</title>
    <meta charset="utf-8" />

    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png">
    <link rel="manifest" href="./favicon/site.webmanifest">
    <link rel="mask-icon" href="./favicon/safari-pinned-tab.svg" color="#999999">
    <link rel="shortcut icon" href="./favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#00a300">
    <meta name="msapplication-config" content="./favicon/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
        @font-face {
            font-family: 'TrajanPro';
            font-display: auto;
            src: url('./fonts/Trajan Pro Bold.ttf') format('truetype');
        }

        @font-face {
            font-family: 'Minion';
            font-display: auto;
            src: url('./fonts/MinionStd-Black.otf') format('opentype');
        }

        html,
        body {
            padding: 0;
            margin: 0;
            font-family: "Times New Roman";
        }

        body:before,
        body:after {
            background-size: contain;
            height: 100%;
            content: '';
            position: fixed;
            width: 100px;
            top: 0;
            background-repeat: repeat-y;
            z-index: 10;
            opacity: 0.3;
        }

        body:before {
            background-image: url('assets/spear-left.png');
            left: 0;
            background-position: left;
        }

        body:after {
            background-image: url('assets/spear-right.png');
            right: 0;
            background-position: right;
        }

        * {
            font-size: 14pt;
        }

        .myCanvas {
            position: absolute;
            top: 10px;
            left: 10px;
            transform-origin: top left;
            transform: scale(0.213854021, 0.213854021);
            #scale(calc(300 / 1403), calc(460 / 2151));
        }

        #load-indicator {
            position: absolute;
            top: 235px;
            left: 160px;
            height: 30px;
            width: 30px;
            padding: 10px;
            margin: -25px 0 0 -25px;
            -webkit-animation: spin 1.5s linear infinite;
            -moz-animation: spin 1.5s linear infinite;
            animation: spin 1.5s linear infinite;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        body.size1 #load-indicator,
        body.size4 #load-indicator,
        body.size5 #load-indicator {
            top: 160px;
            left: 235px;
        }


        @-moz-keyframes spin {
            100% {
                -moz-transform: rotate(360deg);
            }
        }

        @-webkit-keyframes spin {
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

        body:not(.size5) .myCanvas {
            border-radius: 100px;
        }

        body.size1 #portraitCanvas,
        body.size4 #portraitCanvas,
        body.size5 #portraitCanvas,
        body.size0 #landscapeCanvas,
        body.size2 #landscapeCanvas,
        body.size3 #landscapeCanvas,
        body.size5 #landscapeCanvas,
        body.size0 #matCanvas,
        body.size1 #matCanvas,
        body.size2 #matCanvas,
        body.size3 #matCanvas,
        body.size4 #matCanvas {
            display: none;
        }

        #sizes {
            position: absolute;
            display: block;
            top: 490px;
            left: 10px;
            padding: 0;
            margin: 0;
            /*transition: top .25s;*/
        }

        body.size1 #sizes,
        body.size4 #sizes,
        body.size5 #sizes {
            top: calc(490px - 80px);
        }

        #sizes input {
            display: none;
        }

        #sizes label {
            display: inline-block;
            width: 46px;
            height: 46px;
            vertical-align: top;
            text-align: center;
            opacity: 0.5;
        }

        #sizes label:hover,
        #sizes input:checked+label {
            opacity: 1;
            cursor: pointer;
        }

        #download,
        #reset {
            position: absolute;
            left: 20px;
            top: 770px;
        }

        #reset {
            left: calc(40px + 9em);
        }

        #download button,
        #reset button {
            box-sizing: border-box;
            background: #555;
            border: none;
            color: white;
            padding: 0.5em 0.7em;
            cursor: pointer;
            border-radius: 5px;
        }

        #download button img {
            height: 1em;
            position: relative;
            top: 3px;
            margin-right: 0.2em;
        }

        #download button:hover,
        #download button:focus,
        #reset button:hover,
        #reset button:focus {
            background: black;
        }

        button {
            cursor: pointer;
            box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.3);
        }

        button:active {
            position: relative;
            top: 1px;
            box-shadow: none;
        }

        body.size1 #download,
        body.size4 #download,
        body.size5 #download,
        body.size1 #reset,
        body.size4 #reset,
        body.size5 #reset {
            top: calc(770px - 80px);
        }

        #table {
            border-collapse: collapse;
            width: calc(100% - 160px);
            position: relative;
            table-layout: fixed;
            margin: 0.5em 80px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.8);
        }

        #image-positioning table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
            box-sizing: border-box;
        }

        td,
        th {
            vertical-align: top;
            text-align: left;
            border: solid 3px transparent;
        }

        .heading-credits {
            font-size: 0.6em;
        }

        .heading-credits a {
            font-size: 1em;
        }

        td>div,
        th>div {
            padding: 10px;
            background: #CCC;
            border-radius: 7px;
        }

        th {
            font-family: TrajanPro;
        }

        col {
            width: 323px;
            /* 300 + 2*10 (padding) + 3 (border) */
            transition: width .25s;
        }

        body.size1 col,
        body.size4 col,
        body.size5 col {
            width: 483px;
        }

        body.size0 label[for=price]:after,
        body.size3 label[for=price]:after {
            content: " (bottom left)";
        }

        body.size1 label[for=price]:after {
            content: " (top left)";
        }

        label[for=preview]:after {
            content: "Preview (top corners)";
        }

        body.size2 label[for=preview]:after {
            content: "Price";
        }

        label[for=type2]:after {
            content: "Heirloom";
        }

        body.size2 label[for=type2]:after {
            content: "Type";
        }

        body.size3 .hideForBaseCards,
        body.size4 .hideForPileMarker,
        body.size5 .hideForMats {
            visibility: collapse;
            display: none;
        }

        body.size1 #previewCell,
        body:not(.size2) .doubledForDoubleCards+td {
            visibility: collapse;
        }

        body.size1 #priceCell>div,
        body:not(.size2) .doubledForDoubleCards>div,
        body.size3 .doubledForBaseCards>div,
        body.size4 .doubledForPileMarkers>div {
            width: calc(200% + 5px);
            box-sizing: border-box;
        }

        body:not(.size2) label[for=normalcolor1]:before {
            content: "Primary ";
        }

        body:not(.size2) label[for=normalcolor2]:before {
            content: "Secondary ";
        }

        label,
        input,
        textarea,
        select {
            display: block;
            width: 100%;
            margin: 0;
            margin-top: 0.25em;
            border: none;
            outline: none;
            border-radius: 5px;
            padding: 5px;
            box-sizing: border-box;
        }

        label {
            padding: 0;
        }

        textarea {
            resize: vertical;
        }

        input[type=number] {
            display: inline-block;
            width: 30%;
            margin-right: 3%;
        }

        input[type=range] {
            cursor: pointer;
            padding: 0;
        }

        #image-positioning button {
            margin-top: 15px;
            border-radius: 5px;
            border: none;
            background-color: #eee;
            padding: 0.3em 1em;
        }

        #image-positioning button:hover,
        #image-positioning button:focus {
            background-color: #fff;
        }

        [data-status]:after {
            position: absolute;
            top: 492px;
            left: 10px;
            background: rgba(250, 250, 250, 0.6);
            padding: 0.7em 0.7em;
            min-width: 270px;
            content: attr(data-status);
            cursor: wait;
        }

        body.size1 [data-status]:after,
        body.size4 [data-status]:after,
        body.size5 [data-status]:after {
            top: calc(492px - 80px);
        }

        #legend {
            position: absolute;
            left: 10px;
            top: 560px;
            margin-bottom: 0;
            text-align: center;
            font-family: "Times New Roman";
            /*transition: top .25s;*/
        }

        body.size1 #legend,
        body.size4 #legend,
        body.size5 #legend {
            top: calc(560px - 80px);
        }

        #legend li {
            display: block;
            width: 230px;
            margin-right: 2%;
            text-align: left;
        }

        #legend li span.def {
            width: 25px;
            display: inline-block;
            text-align: center;
            font-family: "Minion";
        }

        [name=recolor]:nth-of-type(3n) {
            background: #DDF;
        }

        [name=recolor]:nth-of-type(3n+1) {
            background: #FDD;
        }

        [name=recolor]:nth-of-type(3n+2) {
            background: #DFD;
        }

    </style>
    <script>

        var templateSize = 0; //save globally
        
        // Initialization of complete logic on load of page
        window.addEventListener('load', function() {
            
	//these three can all be expanded as you see fit
	var icons = {//the names should match the image filenames (plus a .png extension).
		"@": ["Debt", "white", "Treasure"],
		"\\^": ["Potion", "white", "Treasure"],
		"%": ["VP", "white", "Victory"],
		"#": ["VP-Token", "white", "Victory"], //German VP Token (not a nice decision of ASS Altenburger, but maybe nice to have to keep the cards consistent)
		"\\$": ["Coin", "black", "Treasure"]
	};
	var normalColorFactorLists = [
		["Action/Event", [1, 1, 1]],
		["Treasure", [1.1, 0.95, 0.55]],
		["Victory", [0.75, 0.9, 0.65]],
		["Reaction", [0.65, 0.8, 1.05]],
		["Duration", [1.2, 0.8, 0.4]],
		["Reserve", [0.9, 0.75, 0.5]],
		["Curse", [0.85, 0.6, 1.1]],
		["Shelter", [1.05, 0.65, 0.5]],
		["Ruins", [0.75, 0.6, 0.35]],
		["Landmark", [0.45, 1.25, 0.85]],
		["Night", [0.3, 0.4, 0.45]],
		["Boon", [1.4, 1.35, 0.55, 0,0,0, 1.7,1.25,0.65, 1.95,1.6,0.4]],
		["Hex", [0.75, 0.6, 2.1, 0,0,0, 0.8,0.8,0.8, 1.0,0.75,2.1]],
		["State", [1.1,1.3,1.3, 0.6,0.15,0, 1.55,1.15,1.05, 1.4,0.65,0.45]],
		["Artifact", [1.15, 1, 0.75, 0.3, 0.15, 0.05]],
		["Project", [1.15, 0.95, 0.9, 0.4, 0.2, 0.15]]
	];
	var boldableKeywords = [ //case-insensitive
		"card",
		"buy",
		"action",
		"coffer",
		"villager",
        
		"aktion",
        "aktionen",
        "karte",
        "karten",
        "kauf",
        "käufe",
        "dorfbewohner",
        "münze",
        "münzen"
	];
    var travellerTypesPattern = new RegExp(["Traveller","Traveler","Reisender","Reisende"].join("|"));
	
	
	var normalColorCustomIndices = [0,0];
	var normalColorDropdowns = document.getElementsByName("normalcolor");
	for (var j = 0; j < normalColorDropdowns.length; ++j) {
		for (var i = 0; i < normalColorFactorLists.length; ++i) { //"- j" because only the first dropdown should have Night
			var option = document.createElement("option");
			option.textContent = normalColorFactorLists[i][0];
			normalColorDropdowns[j].appendChild(option);
		}
		normalColorCustomIndices[j] = normalColorDropdowns[j].childElementCount;
		var customOption = document.createElement("option");
		customOption.textContent = "CUSTOM";
		normalColorDropdowns[j].appendChild(customOption);
		customOption = document.createElement("option");
		customOption.textContent = "EXTRA CUSTOM";
		normalColorDropdowns[j].appendChild(customOption);
		normalColorDropdowns[j].selectedIndex = 0;
	}
	//var templateSize = 0;
	
	var iconList = "[" + Object.keys(icons).join("") + "]";
    function rebuildBoldLinePatternWords() {
        let customBoldableKeywords = document.getElementById("boldkeys").value;
        let boldableKeywordsFull = customBoldableKeywords.length > 0 ? boldableKeywords.concat(customBoldableKeywords.split(";")) : boldableKeywords;
        boldLinePatternWords = RegExp("([-+]\\d+)\\s+(" + boldableKeywordsFull.join("|") +"s?)", "ig");
    }
    var boldLinePatternWords;
    rebuildBoldLinePatternWords();
	//var boldLinePatternIcons = RegExp("[-+]\\d+\\s" + iconList + "\\d+", "ig");
	var iconWithNumbersPattern = "[-+]?(" + iconList + ")([\\d\\?]*[-+\\*]?)";
	var iconWithNumbersPatternSingle = RegExp("^([-+]?\\d+)?" + iconWithNumbersPattern + "(\\S*)$");
	iconWithNumbersPattern = RegExp(iconWithNumbersPattern, "g");
	
	var canvases = document.getElementsByClassName("myCanvas");
		
	var images = [];
	var imagesLoaded = false;
	var recolorFactorList = [
		[0.75, 1.1, 1.35, 0,0,0, 1,2,3,4,5,6],
		[0.75, 1.1, 1.35, 0,0,0, 1,2,3,4,5,6]
	];
	
	var normalColorCurrentIndices = [0,0];
	var recoloredImages = [];
	
	function draw() {
        
		function getRecoloredImage(imageID, colorID, offset) {
			if (!recoloredImages[imageID]) { //http://stackoverflow.com/questions/1445862/possible-to-use-html-images-like-canvas-with-getimagedata-putimagedata
				var cnvs = document.createElement("canvas");
				var w = images[imageID].width, h=images[imageID].height;
				cnvs.width = w; cnvs.height = h;
				var ctx = cnvs.getContext("2d");
				ctx.drawImage(images[imageID], 0,0);
				
				var imgdata = ctx.getImageData(0,0,w,h);
				var rgba = imgdata.data;
				
				offset = offset || 0;
				var recolorFactors;
				if (normalColorCurrentIndices[colorID] === normalColorCustomIndices[colorID])
					recolorFactors = recolorFactorList[colorID].slice(0,3);
				else if (normalColorCurrentIndices[colorID] > normalColorCustomIndices[colorID])
					recolorFactors = recolorFactorList[colorID];
				else
					recolorFactors = normalColorFactorLists[normalColorCurrentIndices[colorID] - colorID][1];
				recolorFactors = recolorFactors.slice();
					
				while (recolorFactors.length < 6)
					recolorFactors.push(0);
				
				if (offset == 0) {
					for (var ch = 0; ch < 3; ++ch)
						recolorFactors[ch] -= recolorFactors[ch + 3];
					for (var px=0,ct=w*h*4; px<ct; px+=4)
						if (rgba[px+3]) //no need to recolor pixels that are fully transparent
							for (var ch = 0; ch < 3; ++ch)
								rgba[px+ch] = Math.max(0, Math.min(255, Math.round(recolorFactors[ch + 3] * 255 + rgba[px+ch] * recolorFactors[ch])));
				} else {
					while (recolorFactors.length < 12)
						recolorFactors.push(genericCustomAccentColors[templateSize & 1][recolorFactors.length]);
					for (var px=0,ct=w*h*4; px<ct; px+=4)
						if (rgba[px+3])
							for (var ch = 0; ch < 3; ++ch)
								rgba[px+ch] = Math.max(0, Math.min(255, rgba[px+ch] * recolorFactors[ch + offset]));
				}
				
				ctx.putImageData(imgdata,0,0);
				recoloredImages[imageID] = cnvs;
			}
			return recoloredImages[imageID];
		}
		
		var iconReplacedWithSpaces = "     ";
		function getWidthOfLineWithIconsReplacedWithSpaces(line) {
			return context.measureText(line.replace(iconWithNumbersPattern, iconReplacedWithSpaces)).width;
		}
		function getIconListing(icon) {
			return icons[icon] || icons["\\"+icon];
		}
		var shadowDistance = 10;
        var italicSubstrings = ["[i]","Heirloom: ","Erbstück: ","This is not in the supply.","Keep this until Clean-up."];
		function writeLineWithIconsReplacedWithSpaces(line, x, y, scale, family, boldSize) {
			boldSize = boldSize || 64;
			context.textAlign = "left";
            
            if (italicSubstrings.some(substring=>line.includes(substring))) {
                context.font = "italic "+context.font;
                if(line.includes("[i]")) {
                    line = line.split("[i]").join("");
                    x += boldSize*scale;
                }
            } else {
                context.font = context.font.replace("italic ","");
            }
            
			var words = line.split(" ");
			for (var i = 0; i < words.length; ++i) {
				var word = words[i];
				context.save();
				while (word) {
					var match = word.match(iconWithNumbersPatternSingle);
					if (match) {
                        var familyOriginal = family;
                        family = "Minion";
						var localY = y;
						var localScale = scale;
						if (words.length === 1) {
							localY += 115 - scale * 48;
							context.font = "bold 192pt " + family;
							localScale = 1.6;
                            if(templateSize===3) {
							    context.font = "bold 222pt " + family;
                                if (word.includes('$')) { // Treasure Base cards
                                    localScale = localScale*2;
                                } else {
                                    localScale = localScale*1.5;
                                }
                            }
						}
						var halfWidthOfSpaces = context.measureText(iconReplacedWithSpaces).width / 2 + 2;
						
						var image = false;
						var iconKeys = Object.keys(icons);
						for (var j = 0; j < iconKeys.length; ++j) {
							if (iconKeys[j].replace("\\", "") == match[2]) {
								image = images[numberFirstIcon + j];
								break;
							}
						}
						
						context.save();
                        if(!match[1] && (match[0].charAt(0)==='+' || match[0].charAt(0)==='-' )) {
                            match[1] = match[0].charAt(0);
                        }
						if (match[1]) {
							if (context.font[0] !== "b")
								context.font = "bold " + context.font;
							    context.fillText(match[1], x, localY);
							    x += context.measureText(match[1]).width+10*localScale;
						}
						
						x += halfWidthOfSpaces;
						
						context.translate(x,localY);
						context.scale(localScale, localScale);
						if (image && image.height) { //exists
							//context.shadowColor = "#000";
							context.shadowBlur = 25;
							context.shadowOffsetX = localScale * shadowDistance;
							context.shadowOffsetY = localScale * shadowDistance;
							context.drawImage(image, image.width/-2, image.height/-2);
							context.shadowColor = "transparent";
						} //else... well, that's pretty weird, but so it goes.
						if (match[3]) { //text in front of image
							context.textAlign = "center";
							context.fillStyle = getIconListing(match[2])[1];
                            let cost = match[3];
                            let bigNumberScale = 1;
                            let nx = localScale>1.4 ? 0 : -5*localScale^2;
                            let ny = localScale>1 ? 6*localScale : localScale>0.7 ? 12*localScale : localScale>0.5 ? 24*localScale : 48*localScale;
                            if (localScale > 3) {
                                bigNumberScale = 0.8;
                                ny -= (115*0.2)/2;
                            }
                            if(cost.length >= 2) {
                                // special handling for overpay and variable costs
                                let specialCost = cost.slice(-1);
                                let specialCostSize = 45;
                                let syShift = 0;
                                if (specialCost === '*') {
                                    //specialCost = '✱';
                                    specialCostSize = 65;
                                    syShift = 10;
                                    if(cost.length>2) {
                                        bigNumberScale = 1.5/(cost.length-1);
                                    }
                                } else if (specialCost === '+') {
                                    specialCost = '✚';
                                    specialCostSize = 40;
                                    if(cost.length>2) {
                                        bigNumberScale = 1.5/(cost.length-1);
                                    }
                                } else {
                                    specialCost = null;
                                    bigNumberScale = 1.5/cost.length;
                                }
                                if(specialCost != null) {
                                    cost = cost.slice(0, -1) + " ";
                                    context.font = "bold " + specialCostSize + "pt " + family;
                                    let sx = localScale>1 ? 45/2*localScale : 45*localScale;
                                    let sy = localScale>1 ? -20*localScale : 12*localScale-35*localScale;
                                    if(cost.length >= 3) {
                                        nx -= specialCostSize*1/3;
                                        sx += specialCostSize*1/3;
                                    }
                                    sy += syShift*localScale;
                                    context.fillText(specialCost, sx, sy);
                                }
                            }
							context.font = "bold " + 115*bigNumberScale + "pt " + family;
                            context.fillText(cost, nx, ny);
							//context.strokeText(match[3], 0, 0);
						}
						context.restore();
                        family = familyOriginal;
						
						x += halfWidthOfSpaces;
						word = match[4];
					} else {
						if (word.match(boldLinePatternWords)) {
							if (words.length === 1)
								context.font = "bold " + boldSize + "pt " + family;
							else
								context.font = "bold " + context.font;
						}
						context.fillText(word, x, y);
						//context.strokeText(word, x, y);
						break; //don't start this again
					}
				}
				x += context.measureText(word + " ").width;
				context.restore();
			}
		}
		function writeSingleLine(line, x, y, maxWidth, initialSize, family) {
			family = family || "TrajanPro";
			var size = (initialSize || 85) + 2;
			do {
				context.font = (size -= 2) + "pt " + family;
			} while (maxWidth && getWidthOfLineWithIconsReplacedWithSpaces(line) > maxWidth);
			writeLineWithIconsReplacedWithSpaces(line, x - getWidthOfLineWithIconsReplacedWithSpaces(line) / 2, y, size / 90, family);
		}
		function writeDescription(elementID, xCenter, yCenter, maxWidth, maxHeight, boldSize) {
            rebuildBoldLinePatternWords();
			var description = document.getElementById(elementID).value.replace(/ *\n */g, " \n ").replace(boldLinePatternWords, "$1\xa0$2") + " \n"; //separate newlines into their own words for easier processing
			var words = description.split(" ");
			var lines;
			var widthsPerLine;
			var heightsPerLine;
			var overallHeight;
			var size = 64 + 2;
			do { //figure out the best font size, and also decide in advance how wide and tall each individual line is
				widthsPerLine = [];
				heightsPerLine = [];
				overallHeight = 0;
				
				size -= 2;
				context.font = size + "pt Times New Roman";
				var widthOfSpace = context.measureText(" ").width;
				lines = [];
				var line = "";
				var progressiveWidth = 0;
				for (var i = 0; i < words.length; ++i) {
					var word = words[i];
					var heightToAdd = 0;
					if (word === "\n") {
						lines.push(line);
						if (line === "") //multiple newlines in a row
							heightToAdd = size * 0.5;
						else if (line === "-") //horizontal bar
							heightToAdd = size * 0.75;
						else if (line.match(boldLinePatternWords) && line.indexOf(" ") < 0) { //important line
							heightToAdd = boldSize * 1.433;
							var properFont = context.font;
							context.font = "bold " + boldSize + "pt Times New Roman"; //resizing up to 64
							progressiveWidth = context.measureText(line).width; //=, not +=
							context.font = properFont;
						} else if (line.match(iconWithNumbersPatternSingle)) {
							heightToAdd = 275; //192 * 1.433
							var properFont = context.font;
							context.font = "bold 192pt Times New Roman";
							progressiveWidth = getWidthOfLineWithIconsReplacedWithSpaces(line); //=, not +=
							context.font = properFont;
						} else //regular word
							heightToAdd = size * 1.433;
						line = ""; //start next line empty
						widthsPerLine.push(progressiveWidth);
						progressiveWidth = 0;
					} else if (progressiveWidth + getWidthOfLineWithIconsReplacedWithSpaces(" " + word) > maxWidth) {
						lines.push(line + " ");
						line = word;
						heightToAdd = size*1.433;
						widthsPerLine.push(progressiveWidth);
						progressiveWidth = getWidthOfLineWithIconsReplacedWithSpaces(word);
					} else {
						if (line.length) {
							line += " ";
							progressiveWidth += widthOfSpace;
						}
						line += word;
						var properFont = context.font;
						if (word.match(boldLinePatternWords)) //e.g. "+1 Action"
							context.font = "bold " + properFont;
						progressiveWidth += getWidthOfLineWithIconsReplacedWithSpaces(word);
						context.font = properFont;
						continue;
					}
					overallHeight += heightToAdd;
					heightsPerLine.push(heightToAdd);
				}
				//overallHeight -= size*1.433;
			} while (overallHeight > maxHeight && size > 16); //can only shrink so far before giving up
			var y = yCenter - (overallHeight -  size*1.433) / 2;
			//var barHeight = size / 80 * 10;
			for (var i = 0; i < lines.length; ++i) {
				var line = lines[i];
				if (line === "-")//horizontal bar
					context.fillRect(xCenter/2,y - size * 0.375 - 5, xCenter,10);
				else if (line.length)
					writeLineWithIconsReplacedWithSpaces(line, xCenter - widthsPerLine[i]/2, y, size / 96, "Times New Roman", boldSize);
				//else empty line with nothing to draw
				y += heightsPerLine[i];
			}
			context.fillStyle = "black";
		}
		function writeIllustrationCredit(x, y, color, bold, size=31) {
			var illustrationCredit = document.getElementById("credit").value;
			if (illustrationCredit) {
				context.font = bold + size+"pt Times New Roman";
				context.fillStyle = color;
				context.fillText(illustrationCredit, x, y);
				context.fillStyle = "#000";
			}
        }
		function writeCreatorCredit(x, y, color, bold, size=31) {
			var creatorCredit = document.getElementById("creator").value;
			if (creatorCredit) {
                context.textAlign = "right"; 
				context.font = bold + size+"pt Times New Roman";
				context.fillStyle = color;
				context.fillText(creatorCredit, x, y);
				context.fillStyle = "#000";
			}
		}
		
		if (!imagesLoaded) {
			imagesLoaded = (function(){
				for (var i = 0; i < images.length; ++i)
					if (!images[i].complete) { return false; }
				return true;
			})();
			if (!imagesLoaded) {
				queueDraw();
				return;
			}
		} //else ready to draw!

		canvases[0].parentNode.setAttribute("data-status", "Redrawing...");
		
		// clear
		for (var i = 0; i < canvases.length; ++i)
			canvases[i].getContext("2d").clearRect(0, 0, canvases[i].width, canvases[i].height);
        
        var context;
        if (templateSize === 0 || templateSize === 2 || templateSize === 3) {
            context = canvases[0].getContext("2d");
        } else if (templateSize === 1 || templateSize === 4) {
            context = canvases[1].getContext("2d");
        } else {
            context = canvases[2].getContext("2d");
        }
            
		//context.save();

		// draw
		
		var picture = images[5];
        var pictureX = document.getElementById("picture-x").value;
        var pictureY = document.getElementById("picture-y").value;
        var pictureZoom = document.getElementById("picture-zoom").value;
		var expansion = images[17];
		var typeLine = document.getElementById("type").value;
		var heirloomLine = document.getElementById("type2").value;
		var previewLine = document.getElementById("preview").value;
		var priceLine = document.getElementById("price").value;
		
		var isEachColorDark = [false, false];
		for (var i = 0; i < 2; ++i)
			isEachColorDark[i] = (i == 1 && normalColorCurrentIndices[1] == 0) ? isEachColorDark[0] : (((normalColorCurrentIndices[i] >= normalColorCustomIndices[i]) ? recolorFactorList[i] : normalColorFactorLists[normalColorCurrentIndices[i] - i][1]).slice(0,3).reduce(function getSum(total, num) {return total + parseFloat(num);}) <= 1.5);
		var differentIntensities = isEachColorDark[0] != isEachColorDark[1];
        
        if(!(differentIntensities || parseInt(normalColorCurrentIndices[1]) == 0 || parseInt(normalColorCurrentIndices[0])+1 == parseInt(normalColorCurrentIndices[1]))){
            document.getElementById('color2splitselector').removeAttribute("style");
        } else {
            document.getElementById('color2splitselector').setAttribute("style","display:none");
        }
		
		function drawPicture(xCenter, yCenter, width, height) {
			if (picture.height) {
				var scale;
				if (picture.width / width > picture.height / height) { //size of area to draw picture to
					scale = height / picture.height;
				} else {
					scale = width / picture.width;
				}
                
                let sizeX = picture.width*scale*pictureZoom;
                let sizeY = picture.height*scale*pictureZoom;
                let spaceX = sizeX - width;
                let spaceY = sizeY - height;
                let moveX = parseFloat(pictureX) * spaceX/2;
                let moveY = parseFloat(pictureY) * spaceY/2; 
                
				context.save();
				context.translate(xCenter+moveX, yCenter+moveY);
				context.scale(scale*pictureZoom, scale*pictureZoom);
				context.drawImage(picture, picture.width/-2, picture.height/-2);
				context.restore();
			}
		}
        function removeCorners(width,height,radius) {
            context.clearRect(0, 0, radius, radius);
            context.clearRect(width-radius, 0, radius, radius);
            context.clearRect(0, height-radius, radius, radius);
            context.clearRect(width-radius, height-radius, radius, radius);
        }
		function drawExpansionIcon(xCenter, yCenter, width, height) {
			if (expansion.height) {
				var scale;
				if (expansion.width / width < expansion.height / height) { //size of area to draw picture to
					scale = height / expansion.height;
				} else {
					scale = width / expansion.width;
				}
				context.save();
				context.translate(xCenter, yCenter);
				context.scale(scale, scale);
				context.drawImage(expansion, expansion.width/-2, expansion.height/-2);
				context.restore();
			}
		}
		
		if (templateSize == 0) { //card
			drawPicture(704, 706, 1150, 835);
            removeCorners(1403,2151,100);
			
			context.drawImage(getRecoloredImage(0,0),0,0); //CardColorOne
			if (normalColorCurrentIndices[1] > 0) { //two colors are different
                let splitPosition = document.getElementById("color2split").value;
                context.drawImage(getRecoloredImage(!differentIntensities ? splitPosition : 12,1),0,0); //CardColorTwo
            }
			context.drawImage(getRecoloredImage(2,0,6),0,0); //CardGray
			context.drawImage(getRecoloredImage(16,0,9),0,0); //CardBrown
			if (normalColorCurrentIndices[0] > 0 && !isEachColorDark[0] && normalColorCurrentIndices[1] == 0) //single (non-Action, non-Night) color
				context.drawImage(images[3],44,1094); //DescriptionFocus
				
			if (travellerTypesPattern.test(typeLine)) {
				context.save();
				context.globalCompositeOperation = "luminosity";
				if (isEachColorDark[0])
					context.globalAlpha = 0.33;
				context.drawImage(images[4],524,1197); //Traveller
				context.restore();
			}
			
			context.textAlign = "center";
			context.textBaseline = "middle";
			//context.font = "small-caps" + context.font;
			if (heirloomLine) {
				context.drawImage(images[13],97,1720); //Heirloom banner
				writeSingleLine(heirloomLine, 701,1799, 1040,58, "Times New Roman");
			}
			if (isEachColorDark[1])
				context.fillStyle = "white";
			writeSingleLine(document.getElementById("title").value, 701, 215, previewLine ? 800 : 1180, 75);
            if(typeLine.split(" - ").length >= 4) {
                let types2 = typeLine.split(" - ");
                let types1 = types2.splice(0,Math.ceil(types2.length / 2)); 
                writeSingleLine(types1.join(" - ")+" -", priceLine ? 750 : 701, 1922 - 26, priceLine ? 890 : 1180, 42);
                writeSingleLine(types2.join(" - "), priceLine ? 750 : 701, 1922 + 26, priceLine ? 890 : 1180, 42);
            } else {
                if(expansion.height>0 && expansion.width>0) {
                    writeSingleLine(typeLine, priceLine ? 730 : 701, 1922, priceLine ? 800 : 900, 64);
                } else {
                    writeSingleLine(typeLine, priceLine ? 750 : 701, 1922, priceLine ? 890 : 1180, 64);
                }
            }
			if (priceLine)
				writeLineWithIconsReplacedWithSpaces(priceLine + " ", 153, 1940, 85/90,"Minion"); //adding a space confuses writeLineWithIconsReplacedWithSpaces into thinking this isn't a line that needs resizing
			if (previewLine) {
				writeSingleLine(previewLine += " ", 223, 210, 0,0,"Minion");
				writeSingleLine(previewLine, 1203, 210, 0,0,"Minion");
			}
			context.fillStyle = (isEachColorDark[0]) ? "white" : "black";
			if (!heirloomLine)
				writeDescription("description", 701, 1500, 960, 660, 64);
			else
				writeDescription("description", 701, 1450, 960, 560, 64);
			writeIllustrationCredit(150, 2038, "white", "");
			writeCreatorCredit(1253, 2038, "white", "");
            
			drawExpansionIcon(1230, 1920, 80, 80);
            
		} else if (templateSize == 1) { //event/landscape
			drawPicture(1075, 584, 1887, 730);
            removeCorners(2151,1403,100);
			
			context.drawImage(getRecoloredImage(6,0),0,0); //EventColorOne
			if (heirloomLine)
				context.drawImage(images[14],146,832); //EventHeirloom
			if (normalColorCurrentIndices[1] > 0) //two colors are different
				context.drawImage(getRecoloredImage(7,1),0,0); //EventColorTwo
			context.drawImage(getRecoloredImage(8,0,6),0,0); //EventUncoloredDetails
			context.drawImage(getRecoloredImage(15,0,9),0,0); //EventBar
			
			//no Traveller
			
			context.textAlign = "center";
			context.textBaseline = "middle";
			//context.font = "small-caps" + context.font;
			if (heirloomLine)
				writeSingleLine(heirloomLine, 1074,900, 1600,58, "Times New Roman");
			if (isEachColorDark[0])
				context.fillStyle = "white";
			writeSingleLine(document.getElementById("title").value, 1075, 165, 780, 70);
			
			if (typeLine) {
				context.save();
				context.translate(1903, 240);
				context.rotate(45*Math.PI/180);
				context.scale(1, 0.8); //yes, the letters are shorter
				writeSingleLine(typeLine, 0,0, 283, 64);
				context.restore();
			}
			
			if (priceLine)
				writeLineWithIconsReplacedWithSpaces(priceLine + " ", 130, 205, 85/90,"Minion"); //adding a space confuses writeLineWithIconsReplacedWithSpaces into thinking this isn't a line that needs resizing
			writeDescription("description", 1075, 1107, 1600, 283, 70);
			writeIllustrationCredit(181, 1272, "black", "bold ");
			writeCreatorCredit(1969, 1272, "black", "bold ");
            
			drawExpansionIcon(1930, 1190, 80, 80);
            
		} else if (templateSize == 2) { //double card
			drawPicture(704, 1075, 1150, 564);
            removeCorners(1403,2151,100);
			
			if (!recoloredImages[9]) recoloredImages[10] = false;
			context.drawImage(getRecoloredImage(9,0),0,0); //DoubleColorOne
			if (!isEachColorDark[0])
				context.drawImage(images[3],44,1330, images[3].width, images[3].height*2/3); //DescriptionFocus
			context.save();
			context.rotate(Math.PI);
			context.drawImage(getRecoloredImage(10, (normalColorCurrentIndices[1] > 0) ? 1 : 0), -1403,-2151); //DoubleColorOne again, but rotated
			if (!isEachColorDark[1])
				context.drawImage(images[3],44-1403,1330-2151, images[3].width, images[3].height*2/3); //DescriptionFocus
			context.restore();
			context.drawImage(images[11],0,0); //DoubleUncoloredDetails //todo
			
			function drawHalfCard(t, l, p, d, colorID) {
				context.textAlign = "center";
				context.textBaseline = "middle";
				//context.font = "small-caps" + context.font;
				//writeSingleLine(document.getElementById(l).value, 701, 215, 1180, 75);
				
				var recolorFactors;
				if (normalColorCurrentIndices[colorID] >= normalColorCustomIndices[colorID])
					recolorFactors = recolorFactorList[colorID];
				else
					recolorFactors = normalColorFactorLists[normalColorCurrentIndices[colorID] - colorID][1];
				
				context.save();
				var title = document.getElementById(l).value;
				var size = 75 + 2;
				do {
					context.font = (size -= 2) + "pt TrajanPro";
				} while (context.measureText(title).width > 750);
				context.textAlign = "left";
				context.fillStyle = "rgb(" + Math.round(recolorFactors[0] * 224) + "," + Math.round(recolorFactors[1] * 224) + "," + Math.round(recolorFactors[2] * 224) + ")";
				context.lineWidth = 15;
				if (isEachColorDark[colorID])
					context.strokeStyle = "white";
				context.strokeText(title, 150, 1287);
				context.fillText(title, 150, 1287);
				context.restore();
				
				if (isEachColorDark[colorID])
					context.fillStyle = "white";
				writeSingleLine(t, p ? 750 : 701, 1922, p ? 890 : 1190, 64);
				if (p)
					writeLineWithIconsReplacedWithSpaces(p + " ", 153, 1940, 85/90,"Minion");
				writeDescription(d, 701, 1600, 960, 460, 64);
				context.restore();
			}
			context.save();
			drawHalfCard(typeLine, "title", priceLine, "description", 0);
			context.save();
			context.translate(1403, 2151); //bottom right corner
			context.rotate(Math.PI);
			shadowDistance = -shadowDistance;
			drawHalfCard(heirloomLine, "title2", previewLine, "description2", (normalColorCurrentIndices[1] > 0) ? 1 : 0);
			shadowDistance = -shadowDistance;
			writeIllustrationCredit(150, 2038, "white", "");
			writeCreatorCredit(1253, 2038, "white", "");
            
			drawExpansionIcon(1230, 1920, 80, 80);
            
		} else if (templateSize == 3) { //base card
			drawPicture(704, 1075, 1150, 1898);
            removeCorners(1403,2151,100);
			
			context.drawImage(getRecoloredImage(20,0),0,0); //CardColorOne
			context.drawImage(getRecoloredImage(21,0,6),0,0); //CardGray
			context.drawImage(getRecoloredImage(22,0,9),0,0); //CardBrown
			
			context.textAlign = "center";
			context.textBaseline = "middle";
			//context.font = "small-caps" + context.font;
			if (heirloomLine) {
				context.drawImage(images[13],97,1720); //Heirloom banner
				writeSingleLine(heirloomLine, 701,1799, 1040,58, "Times New Roman");
			}
			if (isEachColorDark[1])
				context.fillStyle = "white";
			writeSingleLine(document.getElementById("title").value, 701, 215, previewLine ? 800 : 1180, 75);
            if(typeLine.split(" - ").length >= 4) {
                let types2 = typeLine.split(" - ");
                let types1 = types2.splice(0,Math.ceil(types2.length / 2)); 
                writeSingleLine(types1.join(" - ")+" -", priceLine ? 750 : 701, 1945 - 26, priceLine ? 890 : 1180, 42);
                writeSingleLine(types2.join(" - "), priceLine ? 750 : 701, 1945 + 26, priceLine ? 890 : 1180, 42);
            } else {
                if(expansion.height>0 && expansion.width>0) {
                    writeSingleLine(typeLine, priceLine ? 730 : 701, 1945, priceLine ? 800 : 900, 64);
                } else {
                    writeSingleLine(typeLine, priceLine ? 750 : 701, 1945, priceLine ? 890 : 1180, 64);
                }
            }
			if (priceLine)
				writeLineWithIconsReplacedWithSpaces(priceLine + " ", 153, 1947, 85/90,"Minion"); //adding a space confuses writeLineWithIconsReplacedWithSpaces into thinking this isn't a line that needs resizing
			if (previewLine) {
				writeSingleLine(previewLine += " ", 223, 210, 0,0,"Minion");
				writeSingleLine(previewLine, 1203, 210, 0,0,"Minion");
			}
			context.fillStyle = (isEachColorDark[0]) ? "white" : "black";
			if (!heirloomLine)
				writeDescription("description", 701, 1060, 960, 1500, 64);
			else
				writeDescription("description", 701, 1000, 960, 1400, 64);
			writeIllustrationCredit(165, 2045, "white", "");
			writeCreatorCredit(1225, 2045, "white", "");
            
			drawExpansionIcon(1230, 1945, 80, 80);
        } else if (templateSize == 4) { //pile marker
			drawPicture(1075, 702, 1250, 870);
            removeCorners(2151,1403,100);
			
			context.drawImage(getRecoloredImage(24,0,6),0,0); //CardGray
			context.drawImage(getRecoloredImage(23,0),0,0); //CardColorOne
			
			context.textAlign = "center";
			context.textBaseline = "middle";
            
			context.save();
			if (isEachColorDark[1])
				context.fillStyle = "white";
			context.rotate(Math.PI/2);
			writeSingleLine(document.getElementById("title").value, 700, -1920, 500, 75);
            context.restore();
			context.save();
			if (isEachColorDark[1])
				context.fillStyle = "white";
			context.rotate(Math.PI*3/2);
			writeSingleLine(document.getElementById("title").value, -700, 230, 500, 75);
            context.restore();
        } else if (templateSize == 5) { //player mat
			drawPicture(464, 342, 928, 684);
            
			
			context.drawImage(getRecoloredImage(25,0,6),0,0); //MatBannerTop
            if(document.getElementById("description").value.trim().length>0)
                context.drawImage(getRecoloredImage(26,0,6),0,0); //MatBannerBottom
			
			context.textAlign = "center";
			context.textBaseline = "middle";
            
			if (isEachColorDark[1])
				context.fillStyle = "white";
			writeSingleLine(document.getElementById("title").value, 464, 96, 490, 55);
            
            writeDescription("description", 464, 572, 740, 80, 44);
            
			writeIllustrationCredit(15, 660, "white", "", 16);
			writeCreatorCredit(913, 660, "white", "", 16);
            
			drawExpansionIcon(888, 40, 40, 40);
            
        }

		//finish up
		//context.restore();
		
		updateURL();

        document.getElementById("load-indicator").setAttribute("style", "display:none;");
		canvases[0].parentNode.removeAttribute("data-status");
		return;
	}
	var nextDrawInstruction = 0;
	function queueDraw(time) {
		if (nextDrawInstruction)
			window.clearTimeout(nextDrawInstruction);
		nextDrawInstruction = window.setTimeout(draw, time || 1500);
	}
	
	function updateURL() {
		var arguments = "?";
		for (var i = 0; i < simpleOnChangeInputFieldIDs.length; ++i) {
			arguments += simpleOnChangeInputFieldIDs[i] + "=" + encodeURIComponent(document.getElementById(simpleOnChangeInputFieldIDs[i]).value) + "&";
			if (templateSize == 2 && i < simpleOnChangeButOnlyForSize2InputFieldIDs.length)
				arguments += simpleOnChangeButOnlyForSize2InputFieldIDs[i] + "=" + encodeURIComponent(document.getElementById(simpleOnChangeButOnlyForSize2InputFieldIDs[i]).value) + "&";
		}
		arguments += "picture=" + encodeURIComponent(document.getElementById("picture").value) + "&";
		arguments += "expansion=" + encodeURIComponent(document.getElementById("expansion").value);
		for (var i = 0; i < normalColorDropdowns.length; ++i) {
			switch (normalColorCustomIndices[i] - normalColorDropdowns[i].selectedIndex) {
				case 0: //custom
					for (var ch = 0; ch < 3; ++ch)
						arguments += "&c" + i + "." + ch + "=" + recolorInputs[i * 12 + ch].value;
					break;
				case -1: //extra custom
					for (var ch = 0; ch < 12; ++ch) {
						var recolorInputsIndex = i * 12 + ch;
						if (recolorInputs.length <= recolorInputsIndex)
							break;
						arguments += "&c" + i + "." + ((ch / 3) | 0) + "." + (ch % 3) + "=" + recolorInputs[i * 12 + ch].value;
					}
					break;
				default: //preconfigured
					arguments += "&color" + i + "=" + normalColorDropdowns[i].selectedIndex;
					break;
			}
		}
		arguments += "&size=" + templateSize;
		history.replaceState({}, "Dominion Card Image Generator", arguments);
	}
	function getQueryParams(qs) { //http://stackoverflow.com/questions/979975/how-to-get-the-value-from-the-get-parameters
		qs = qs.split('+').join(' ');
		
		var params = {},
			tokens,
			re = /[?&]?([^&=]+)=?([^&]*)/g;
			
		while (tokens = re.exec(qs)) {
			params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
		}
		
		return params;
	}
            
            
    // help function to load images CORS save // https://stackoverflow.com/a/43001137
    function loadImgAsBase64(url, callback) {
        let canvas = document.createElement('CANVAS');
        let img = document.createElement('img');
        img.setAttribute('crossorigin', 'anonymous');
        img.src = 'https://cors-anywhere.herokuapp.com/'+url;
        img.onload = () => {
            canvas.height = img.height;
            canvas.width = img.width;
            let context = canvas.getContext('2d');
            context.drawImage(img,0,0);
            let dataURL = canvas.toDataURL('image/png');
            canvas = null;
            callback(dataURL);
        };
    }
    var useCORS = true; // flag to activate loading of external images via CORS helper function -> otherwise canvas is tainted and download button not working


	// initialize stage
	var sources = [
		"CardColorOne.png",
		"CardColorTwo.png",
		"CardGray.png",
		"DescriptionFocus.png",
		"Traveller.png",
		"", //illustration //5
		"EventColorOne.png",
		"EventColorTwo.png",
		"EventBrown.png",
		"DoubleColorOne.png",
		"DoubleColorOne.png", //10
		"DoubleUncoloredDetails.png",
		"CardColorTwoNight.png",
		"Heirloom.png",
		"EventHeirloom.png",
		"EventBrown2.png", //15
		"CardBrown.png",
        "", //expansion
		"CardColorTwoSmall.png",
		"CardColorTwoBig.png",
		"BaseCardColorOne.png", //20
		"BaseCardGray.png",
		"BaseCardBrown.png",
		"PileMarkerColorOne.png",
		"PileMarkerGrey.png",
        "MatBannerTop.png",
        "MatBannerBottom.png"
		//icons come afterwards
	];
	for (var i = 0; i < sources.length; i++)
		recoloredImages.push(false);
	var legend = document.getElementById("legend");
    var numberFirstIcon = sources.length;
	for (key in icons) {
		var li =  document.createElement("li");
		li.textContent = ": " + icons[key][0];
        var span = document.createElement("span");
        span.classList.add("def");
        span.textContent = key.replace("\\", "");
        li.insertBefore(span, li.firstChild);
		legend.insertBefore(li, legend.firstChild);
		sources.push(icons[key][0] + ".png");
	}
	for (var i = 0; i < sources.length; i++) {
		images.push(new Image());
		images[i].src = "card-resources/"+sources[i];
	}
	
	var simpleOnChangeInputFieldIDs = ["title", "description", "type", "credit", "creator", "price", "preview", "type2", "color2split", "boldkeys", "picture-x", "picture-y", "picture-zoom"];
	var simpleOnChangeButOnlyForSize2InputFieldIDs = ["title2", "description2"];
	for (var i = 0; i < simpleOnChangeInputFieldIDs.length; ++i) {
		document.getElementById(simpleOnChangeInputFieldIDs[i]).onchange = queueDraw;
		if (i < simpleOnChangeButOnlyForSize2InputFieldIDs.length)
			document.getElementById(simpleOnChangeButOnlyForSize2InputFieldIDs[i]).onchange = queueDraw;
	}
	var recolorInputs = document.getElementsByName("recolor");
	var alreadyNeededToDetermineCustomAccentColors = false;
	for (var i = 0; i < recolorInputs.length; ++i)
		recolorInputs[i].onchange = function(i){return function() {
			var val = parseFloat(this.value);
			if (val !== NaN) {
				var imageID = Math.floor(i / 12);
				if (normalColorCurrentIndices[imageID] >= 10) { //potentially recoloring the supposedly Uncolored images
					recoloredImages[2] = false;
					recoloredImages[8] = false;
					recoloredImages[11] = false;
					recoloredImages[15] = false;
					recoloredImages[16] = false;
				}
				recoloredImages[imageID] = false;
				recoloredImages[imageID + 6] = false;
				recoloredImages[imageID + 9] = false;
				recoloredImages[12] = false;
			    recoloredImages[18] = false;
			    recoloredImages[19] = false;
			    recoloredImages[20] = false;
			    recoloredImages[23] = false;
				recolorFactorList[imageID][i % 12] = val;
				queueDraw();
			}
		}}(i);
    function onChangeExternalImage(id, value) {
        let url = (sources[id] = value.trim());
        function setImageSource(src) {
            images[id].src = src;
		    imagesLoaded = false;
		    queueDraw(250);
        }
        if(url.length>0 && useCORS){
            loadImgAsBase64(url, (dataURL) => { setImageSource(dataURL) }); 
        } else { 
            setImageSource(url)
        }
    }
	document.getElementById("picture").onchange = function() {
        onChangeExternalImage(5, this.value);
	};
	document.getElementById("expansion").onchange = function() {
        onChangeExternalImage(17, this.value);
	};
	var genericCustomAccentColors = [
		[0,0,0, 0,0,0, 1,1,1, 1.2, 0.8, 0.5],
		[0,0,0, 0,0,0, 0.9, 0.8, 0.7, 0.9, 0.8, 0.7]
	];
	for (i = 0; i < normalColorDropdowns.length; ++i)
		normalColorDropdowns[i].onchange = function(i){return function() {
			if (normalColorCurrentIndices[i] >= 10 || this.selectedIndex >= 10) { //potentially recoloring the supposedly Uncolored images
				recoloredImages[2] = false;
				recoloredImages[8] = false;
				recoloredImages[11] = false;
				recoloredImages[15] = false;
				recoloredImages[16] = false;
			}
			normalColorCurrentIndices[i] = this.selectedIndex;
			recoloredImages[i] = false;
			recoloredImages[i + 6] = false;
			recoloredImages[i + 9] = false;
			recoloredImages[2] = false;
			recoloredImages[12] = false;
			recoloredImages[18] = false;
			recoloredImages[19] = false;
			recoloredImages[20] = false;
			recoloredImages[23] = false;
			var delta = normalColorCustomIndices[i] - this.selectedIndex;
			if (delta <= 0)
				this.nextElementSibling.removeAttribute("style");
			else
				this.nextElementSibling.setAttribute("style", "display:none;");
			if (delta === -1) {
				this.nextElementSibling.nextElementSibling.removeAttribute("style");
				if (i === 0 && !alreadyNeededToDetermineCustomAccentColors) {
					alreadyNeededToDetermineCustomAccentColors = true;
					for (var j = 6; j < 12; ++j)
						recolorFactorList[0][j] = recolorInputs[j].value = genericCustomAccentColors[templateSize & 1][j];
				}
			} else
				this.nextElementSibling.nextElementSibling.setAttribute("style", "display:none;");
			queueDraw(1);
		}}(i);
	var templateSizeInputs = document.getElementsByName("size");
	for (var i = 0; i < templateSizeInputs.length; ++i)
		templateSizeInputs[i].onchange = function(i){return function() {
			templateSize = parseInt(this.value);
			document.body.className = this.id;
            document.getElementById("load-indicator").removeAttribute("style");
			queueDraw(250);
		}}(i);
	
	//ready to begin: load information from query parameters
	var query = getQueryParams(document.location.search);
	for (var queryKey in query) {
		switch (queryKey) {
			case "color0":
				normalColorCurrentIndices[0] = normalColorDropdowns[0].selectedIndex = query[queryKey];
				break;
			case "color1":
				normalColorCurrentIndices[1] = normalColorDropdowns[1].selectedIndex = query[queryKey];
				break;
			case "size":
				var buttonElement = document.getElementsByName("size")[templateSize = parseInt(query[queryKey])];
				document.body.className = buttonElement.id;
				buttonElement.checked = true;
				break;
			default:
				var matches = queryKey.match(/^c(\d)\.(\d)$/);
				if (matches) {
					var id = matches[1];
					normalColorCurrentIndices[id] = normalColorDropdowns[id].selectedIndex = normalColorCustomIndices[id];
					normalColorDropdowns[id].nextElementSibling.removeAttribute("style");
					recolorFactorList[id][matches[2]] = recolorInputs[12*id + parseInt(matches[2])].value = parseFloat(query[queryKey]);
				} else {
					matches = queryKey.match(/^c(\d)\.(\d)\.(\d)$/);
					if (matches) {
						alreadyNeededToDetermineCustomAccentColors = true;
						var id = matches[1];
						normalColorCurrentIndices[id] = normalColorDropdowns[id].selectedIndex = normalColorCustomIndices[id] + 1;
						normalColorDropdowns[id].nextElementSibling.removeAttribute("style");
						normalColorDropdowns[id].nextElementSibling.nextElementSibling.removeAttribute("style");
						recolorFactorList[id][parseInt(matches[2]) * 3 + parseInt(matches[3])] = recolorInputs[12*id + 3*parseInt(matches[2]) + parseInt(matches[3])].value = parseFloat(query[queryKey]);
					} else {
						var el = document.getElementById(queryKey);
						if (el)
							el.value = query[queryKey];
					}
				}
				break;
		}
		for (var i = 0; i < simpleOnChangeButOnlyForSize2InputFieldIDs.length; ++i)
			if (!document.getElementById(simpleOnChangeButOnlyForSize2InputFieldIDs[i]).value)
				document.getElementById(simpleOnChangeButOnlyForSize2InputFieldIDs[i]).value = document.getElementById(simpleOnChangeButOnlyForSize2InputFieldIDs[i].substr(0, simpleOnChangeButOnlyForSize2InputFieldIDs[i].length - 1)).value;
	}
    //set the illustration's Source properly and also call queueDraw.
	document.getElementById("picture").onchange(); 
	document.getElementById("expansion").onchange();
            
    //adjust page title
    function adjustPageTitle() {
        let cardTitle = document.getElementById("title").value.trim();
        let creator = document.getElementById("creator").value.trim();
        let pageDefaultTitle = "Dominion Card Image Generator";
        document.title = cardTitle.length > 0 ? (pageDefaultTitle+" - "+cardTitle+" "+creator) : pageDefaultTitle;
    };
    document.getElementById('title').addEventListener('change', adjustPageTitle, false);
    document.getElementById('creator').addEventListener('change', adjustPageTitle, false);
    adjustPageTitle();
            
    //pass parameters to original version to enable easy comparison
    document.getElementById('linkToOriginal').addEventListener('click', function(event) {
        event.preventDefault();
        window.location.href = this.href + document.location.search;
    }, false);
            
});
        
        // function to download the finished card
        function downloadPicture() {
        
            function dataURLtoBlob(dataurl) {
                var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], {type:mime});
            }
            
            var id;
            if (templateSize == 0 || templateSize == 2 || templateSize == 3) {
                id = 0;
            } else if (templateSize == 1 || templateSize == 4) {
                id = 1;
            } else {
                id = 2;
            }
            var link = document.getElementById("download");
            var canvases = document.getElementsByClassName("myCanvas");
            var canvas = canvases[id];
            var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
            var title = document.getElementById("title").value.trim();
            var creator = document.getElementById("creator").value.trim();
            var fileName = "";
            if(title.length>0) {
                fileName += title;
            } else {
                fileName += "card";
            }
            if(creator.length>0) {
                fileName += "_" + creator.split(" ")[0];
            }
            fileName = fileName.split(" ").join("_");
            fileName += ".png";
            link.setAttribute('download', fileName);
            var url = (window.webkitURL || window.URL).createObjectURL(dataURLtoBlob(image));
            link.setAttribute("href", url);
        }
        
        </script>
</head>

<body class="size0">
    <table id="table">
        <colgroup>
            <col>
        </colgroup>
        <tr>
            <th rowspan="9" data-status="Loading...">
                <canvas class="myCanvas" id="portraitCanvas" width="1403" height="2151" title="Right-Click this image for options to save it.">Your browser does not support the &lt;CANVAS&gt; tag.</canvas>
                <canvas class="myCanvas" id="landscapeCanvas" width="2151" height="1403" title="Right-Click this image for options to save it.">Your browser does not support the &lt;CANVAS&gt; tag.</canvas>
                <canvas class="myCanvas" id="matCanvas" width="928" height="684" style="transform:scale(0.49);" title="Right-Click this image for options to save it.">Your browser does not support the &lt;CANVAS&gt; tag.</canvas>
                <img id="load-indicator" src="assets/spinner.png" alt="Loading..." />
                <menu id="sizes">
                    <input type="radio" name="size" id="size0" value="0" checked />
                    <label for="size0">
                        <img src="card-resources/CardPortraitIcon.png" width="30" height="46" alt="" title="Portrait" />
                    </label>
                    <input type="radio" name="size" id="size1" value="1" />
                    <label for="size1">
                        <img src="card-resources/EventBrown.png" width="46" height="30" alt="" title="Landscape" />
                    </label>
                    <input style="display:none" type="radio" name="size" id="size2" value="2" />
                    <label style="display:none" for="size2">
                        <img src="card-resources/DoubleUncoloredDetails.png" width="30" height="46" alt="" title="Double" />
                    </label>
                    <input type="radio" name="size" id="size3" value="3" />
                    <label for="size3">
                        <img src="card-resources/BaseCardIcon.png" width="30" height="46" alt="" title="Base Card" />
                    </label>
                    <input type="radio" name="size" id="size4" value="4" />
                    <label for="size4">
                        <img src="card-resources/PileMarkerIcon.png" width="46" height="30" alt="" title="Pile Marker" />
                    </label>
                    <input type="radio" name="size" id="size5" value="5" />
                    <label for="size5" style="margin-left:0.5em;">
                        <img src="card-resources/MatIcon.png" width="62" height="46" alt="" title="Player Mat" />
                    </label>
                </menu>
                <ul id="legend">
                    <li><span class="def">-</span>: horizontal bar</li>
                    <li><span class="def">[i]</span>: italic line</li>
                </ul>
                <a id="download" target="_blank" title="click to download card image file" download="card.png"><button type="button" onclick="downloadPicture()"><img src="assets/icon-download.png" />Download Card</button></a>
                <a id="reset" href="?" title="click to reset all fields"><button type="button">Reset</button></a>
            </th>
            <th colspan="2">Dominion Card Image Generator (<a id="linkToOriginal" href="https://shemitz.net/static/dominion3/" title="click to pass inputs to the original version">Original</a> &amp; <a target="_blank" rel="nofollow" href="http://forum.dominionstrategy.com/index.php?topic=16622.msg787231#new" title="show discussion, description and announcements in the forum">Discussion</a>) <span class="heading-credits">Extended Version (<a target="_blank" rel="nofollow" href="https://github.com/shardofhonor/dominion-card-generator" title="view source on github and contribute code">Join Development</a>)</span></th>
        </tr>
        <tr>
            <td class="doubledForDoubleCards">
                <div>
                    <label for="title">Title</label>
                    <input id="title" placeholder="Village" />
                </div>
            </td>
            <td>
                <div>
                    <label for="title2">Title</label>
                    <input id="title2" />
                </div>
            </td>
        </tr>
        <tr>
            <td class="doubledForDoubleCards hideForPileMarker">
                <div>
                    <label for="description">Description</label>
                    <textarea rows="5" id="description" placeholder="+1 Card
+2 Actions"></textarea>
                    <div>
                        <label for="boldkeys">Additional Bold Keywords</label>
                        <input id="boldkeys" placeholder="Additional boldable keywords, separated by semikolon" />
                    </div>
            </td>
            <td class="hideForPileMarker hideForMats">
                <div>
                    <label for="description2">Description</label>
                    <textarea rows="5" id="description2"></textarea>
                </div>
            </td>
        </tr>
        <tr>
            <td class="doubledForBaseCards hideForPileMarker hideForMats">
                <div>
                    <label for="type">Type</label>
                    <input id="type" placeholder="Action" />
                </div>
            </td>
            <td class="hideForBaseCards hideForPileMarker hideForMats">
                <div>
                    <label for="type2"></label>
                    <input id="type2" />
                </div>
            </td>
        </tr>
        <tr>
            <td rowspan="3" class="doubledForPileMarkers">
                <div id="image-positioning">
                    <label for="picture">URL of Illustration</label>
                    <input id="picture" type="url" placeholder="http://www.example.com/image.jpg" />
                    <table>
                        <tr>
                            <td><label for="picture-x">Position X:</label></td>
                            <td colspan="2"><input id="picture-x" type="range" min="-1" max="1" value="0" step="0.01"></td>
                        </tr>
                        <tr>
                            <td><label for="picture-y">Position Y:</label></td>
                            <td colspan="2"><input id="picture-y" type="range" min="-1" max="1" value="0" step="0.01"></td>
                        </tr>
                        <tr>
                            <td><label for="picture-zoom">Zoom:</label></td>
                            <td colspan="2"><input id="picture-zoom" type="range" min="1" max="3" value="1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td colspan="3"><button onclick="(function(){
                                     document.getElementById('picture-x').value=0;
                                     document.getElementById('picture-y').value=0;
                                     let z = document.getElementById('picture-zoom');z.value=1;
                                     z.onchange();})();">Reset Position</button></td>
                        </tr>
                    </table>
                </div>
            </td>
            <td class="hideForPileMarker">
                <div>
                    <label for="expansion">URL of Expansion Icon</label>
                    <input id="expansion" type="url" placeholder="http://www.example.com/icon.png" />
                </div>
            </td>
        </tr>
        <tr>
            <td class="hideForPileMarker">
                <div>
                    <label for="credit">Art Credit</label>
                    <input id="credit" type="text" placeholder="Illustration: Jane Doe" />
                </div>
            </td>
        </tr>
        <tr>
            <td class="hideForPileMarker">
                <div>
                    <label for="creator">Version &amp; Creator Credit</label>
                    <input id="creator" type="text" placeholder="v0.1 John Doe" />
                </div>
            </td>
        </tr>
        <tr>
            <td id="priceCell" class="hideForPileMarker hideForMats">
                <div>
                    <label for="price">Price</label>
                    <input id="price" placeholder="$3" />
            </td>
            <td id="previewCell" class="hideForPileMarker hideForMats">
                <div>
                    <label for="preview"></label>
                    <input id="preview" />
                </div>
            </td>
        </tr>
        <tr>
            <td class="hideForMats doubledForBaseCards doubledForPileMarkers">
                <div>
                    <label for="normalcolor1">Color</label>
                    <select name="normalcolor" id="normalcolor1">
                    </select>
                    <div style="display:none;" title="Card color">
                        <input type="number" name="recolor" min="0" max="10" step=".05" value="0.75" /><input type="number" name="recolor" min="0" max="10" step=".05" value="1.1" /><input type="number" name="recolor" min="0" max="10" step=".05" value="1.35" />
                    </div>
                    <div style="display:none;">
                        <div title="Card fade color"><input type="number" name="recolor" min="0" max="10" step=".05" value="0" /><input type="number" name="recolor" min="0" max="10" step=".05" value="0" /><input type="number" name="recolor" min="0" max="10" step=".05" value="0" /></div>
                        <div title="Accent color 1"><input type="number" name="recolor" min="0" max="10" step=".05" value="1" /><input type="number" name="recolor" min="0" max="10" step=".05" value="2" /><input type="number" name="recolor" min="0" max="10" step=".05" value="3" /></div>
                        <div title="Accent color 2"><input type="number" name="recolor" min="0" max="10" step=".05" value="4" /><input type="number" name="recolor" min="0" max="10" step=".05" value="5" /><input type="number" name="recolor" min="0" max="10" step=".05" value="6" /></div>
                    </div>
                </div>
            </td>
            <td class="hideForBaseCards hideForPileMarker hideForMats">
                <div>
                    <label for="normalcolor2">Color</label>
                    <select name="normalcolor" id="normalcolor2">
                        <option>SAME</option>
                    </select>
                    <div style="display:none;" title="Card color">
                        <input type="number" name="recolor" min="0" max="10" step=".05" value="0.75" /><input type="number" name="recolor" min="0" max="10" step=".05" value="1.1" /><input type="number" name="recolor" min="0" max="10" step=".05" value="1.35" />
                    </div>
                    <div style="display:none;" title="Card fade color">
                        <input type="number" name="recolor" min="0" max="10" step=".05" value="0" /><input type="number" name="recolor" min="0" max="10" step=".05" value="0" /><input type="number" name="recolor" min="0" max="10" step=".05" value="0" />
                    </div>
                    <div id="color2splitselector" style="display:none;">
                        <label for="color2split">Split Position</label>
                        <select name="color2split" id="color2split">
                            <option value="18">Smaller Top</option>
                            <option value="1" selected="selected">Half</option>
                            <option value="19">Smaller Bottom</option>
                        </select>
                    </div>
                </div>
            </td>
        </tr>
    </table>
</body>

</html>
